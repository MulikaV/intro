"use strict";

exports.__esModule = true;
exports["default"] = void 0;

var _actions = require("../actions");

var shouldActionBePromisified = function shouldActionBePromisified(action, auto) {
  return auto && !(action.meta && action.meta.asPromise === false) || action.meta && action.meta.asPromise;
};

var _default = function _default(_temp) {
  var _ref = _temp === void 0 ? {} : _temp,
      _ref$auto = _ref.auto,
      auto = _ref$auto === void 0 ? false : _ref$auto;

  var requestMap = new Map();
  return function () {
    return function (next) {
      return function (action) {
        if ((0, _actions.isRequestAction)(action) && shouldActionBePromisified(action, auto)) {
          return new Promise(function (resolve, reject) {
            requestMap.set(action, function (response, error) {
              return error ? reject(response) : resolve(response);
            });
            next(action);
          });
        }

        if ((0, _actions.isResponseAction)(action)) {
          var requestAction = (0, _actions.getRequestActionFromResponse)(action);

          if (shouldActionBePromisified(requestAction, auto)) {
            var requestActionPromise = requestMap.get(requestAction);
            requestActionPromise(action, action.type !== (0, _actions.success)(requestAction.type));
            requestMap["delete"](requestAction);
          }
        }

        return next(action);
      };
    };
  };
};

exports["default"] = _default;