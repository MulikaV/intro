"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports["default"] = void 0;

var _objectWithoutPropertiesLoose2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutPropertiesLoose"));

var _extends9 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _actions = require("../actions");

function _toPropertyKey(arg) { var key = _toPrimitive(arg, "string"); return typeof key === "symbol" ? key : String(key); }

function _toPrimitive(input, hint) { if (typeof input !== "object" || input === null) return input; var prim = input[Symbol.toPrimitive]; if (prim !== undefined) { var res = prim.call(input, hint || "default"); if (typeof res !== "object") return res; throw new TypeError("@@toPrimitive must return a primitive value."); } return (hint === "string" ? String : Number)(input); }

var mutationConfigHasRequestKey = function mutationConfigHasRequestKey(config) {
  return typeof config !== 'boolean' && !!config.getRequestKey;
};

var updateMutationsForRequest = function updateMutationsForRequest(state, action, mutationConfig) {
  var _extends4;

  if (mutationConfig.local) {
    return state;
  }

  if (mutationConfigHasRequestKey(mutationConfig)) {
    var _extends2, _extends3;

    var requestKey = mutationConfig.getRequestKey(action);
    return (0, _extends9["default"])({}, state, (_extends3 = {}, _extends3[action.type] = (0, _extends9["default"])({}, state[action.type], (_extends2 = {}, _extends2[requestKey] = {
      error: null,
      pending: state[action.type] && state[action.type][requestKey] ? state[action.type][requestKey].pending + 1 : 1
    }, _extends2)), _extends3));
  }

  return (0, _extends9["default"])({}, state, (_extends4 = {}, _extends4[action.type] = {
    error: null,
    pending: (state[action.type] ? state[action.type].pending : 0) + 1
  }, _extends4));
};

var _default = function _default(state, action, config, mutationConfig) {
  var _extends8;

  if (!(0, _actions.isResponseAction)(action)) {
    return updateMutationsForRequest(state, action, mutationConfig);
  }

  var requestAction = (0, _actions.getRequestActionFromResponse)(action);
  var _requestAction$type = requestAction.type,
      currentMutation = state[_requestAction$type],
      otherMutations = (0, _objectWithoutPropertiesLoose2["default"])(state, [_requestAction$type].map(_toPropertyKey));

  if ((0, _actions.isErrorAction)(action)) {
    var _extends5, _extends6;

    return (0, _extends9["default"])({}, otherMutations, (_extends6 = {}, _extends6[requestAction.type] = mutationConfigHasRequestKey(mutationConfig) ? (0, _extends9["default"])({}, currentMutation, (_extends5 = {}, _extends5[mutationConfig.getRequestKey(requestAction)] = {
      error: config.getError(state, action, config),
      pending: currentMutation[mutationConfig.getRequestKey(requestAction)].pending - 1
    }, _extends5)) : {
      error: config.getError(state, action, config),
      pending: currentMutation.pending - 1
    }, _extends6));
  } // success or abort case


  var getUpdatedCurrentMutation = function getUpdatedCurrentMutation() {
    if (!mutationConfigHasRequestKey(mutationConfig)) {
      return {
        error: null,
        pending: currentMutation.pending - 1
      };
    }

    var currentRequestKey = mutationConfig.getRequestKey(requestAction);
    var mutationForRequestKey = currentMutation[currentRequestKey],
        remainingMutations = (0, _objectWithoutPropertiesLoose2["default"])(currentMutation, [currentRequestKey].map(_toPropertyKey));

    if (mutationForRequestKey.pending !== 1) {
      var _extends7;

      return (0, _extends9["default"])({}, remainingMutations, (_extends7 = {}, _extends7[currentRequestKey] = {
        error: null,
        pending: mutationForRequestKey.pending - 1
      }, _extends7));
    }

    return remainingMutations;
  };

  return (0, _extends9["default"])({}, otherMutations, (_extends8 = {}, _extends8[requestAction.type] = getUpdatedCurrentMutation(), _extends8));
};

exports["default"] = _default;